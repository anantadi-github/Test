version: "3.8"

services:
  srt2hls:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: srt2hls
    restart: unless-stopped
    environment:
      PUBLIC_IP: "${PUBLIC_IP:-<EC2_PUBLIC_IP_OR_DOMAIN>}"

      INPUT_PORT: "9000"
      HLS_DIR: "/var/www/html/hls"
      HEALTH_PORT: "8088"

      HLS_TIME_SEC: "2"
      HLS_LIST_SIZE: "6"
      HEALTH_MAX_STALENESS_SEC: "10"
      CLEANUP_ON_START: "true"

      # SRT tuning (WAN-safe defaults)
      SRT_LATENCY_US: "800000"
      SRT_RCVBUF_BYTES: "268435456"

      # Input probing/format override
      INPUT_FORMAT: "mpegts"
      PROBE_SIZE: "5M"
      ANALYZE_DURATION: "5M"

      # Copy video (no decode)
      VIDEO_CODEC: "copy"

      # Make audio safe for HLS
      AUDIO_CODEC: "aac"
      AUDIO_BITRATE: "128k"

      # Publish gating
      PRIVATE_PLAYLIST: "stream.m3u8"
      PUBLIC_PLAYLIST: "live.m3u8"
      PUBLISH_STABLE_SECONDS: "8"
      REQUIRE_SEGMENTS: "2"
      FFPROBE_VALIDATE: "true"

      # Internal SRT->UDP hop (if your script uses it)
      UDP_HOST: "127.0.0.1"
      UDP_PORT: "10000"

    ports:
      - "9000:9000/udp"     # SRT input
      - "8088:8088/tcp"     # health endpoint
    volumes:
      - hls_data:/var/www/html/hls

  nginx:
    image: nginx:alpine
    container_name: hls-nginx
    restart: unless-stopped
    depends_on:
      - srt2hls
    ports:
      - "80:80/tcp"
    volumes:
      - hls_data:/usr/share/nginx/html/hls:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro

volumes:
  hls_data:
