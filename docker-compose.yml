version: "3.8"

services:
  srt2hls:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: srt2hls
    restart: unless-stopped
    environment:
      PUBLIC_IP: "${PUBLIC_IP:-<EC2_PUBLIC_IP_OR_DOMAIN>}"

      INPUT_PORT: "9000"
      HLS_DIR: "/var/www/html/hls"
      PLAYLIST_NAME: "stream.m3u8"
      HLS_TIME_SEC: "2"
      HLS_LIST_SIZE: "6"
      HEALTH_PORT: "8088"
      HEALTH_MAX_STALENESS_SEC: "10"
      CLEANUP_ON_START: "true"

      # SRT tuning (WAN-safe defaults)
      SRT_LATENCY_US: "800000"          # 800ms
      SRT_RCVBUF_BYTES: "268435456"     # 256MB

      # Input probing/format override
      INPUT_FORMAT: "mpegts"
      PROBE_SIZE: "5M"
      ANALYZE_DURATION: "5M"

      # ✅ Copy video (no decode)
      VIDEO_CODEC: "copy"

      # ✅ Make HLS audio safe
      AUDIO_CODEC: "aac"
      AUDIO_BITRATE: "128k"

      # Ignored when VIDEO_CODEC=copy
      FORCE_KEYFRAMES: "false"
      
      UDP_HOST: "127.0.0.1"
      VIDEO_CRF: "23"
      X264_PRESET: "superfast"
      X264_TUNE: "zerolatency"
      UDP_HOST: "127.0.0.1"
      UDP_PORT: "10000"
    ports:
      - "9000:9000/udp"
